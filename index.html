<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>전국 구별 아파트 평당가 TOP 10</title>
<meta property="og:title" content="전국 구별 아파트 평당가 TOP 10 | HerdVibe">
<meta property="og:description" content="최근 6개월 실거래 기준 · 전용면적 59㎡ 이상 · 단지별 최고가">
<meta property="og:url" content="https://herdvibe.com/37">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
<noscript><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet"></noscript>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" defer></script>
<script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.4/kakao.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
::-webkit-scrollbar{display:none}
*{-ms-overflow-style:none;scrollbar-width:none}

:root{
--bg-primary:#0a0a0a;--bg-secondary:#111111;--bg-tertiary:#1a1a1a;
--text-primary:#ffffff;--text-secondary:#888888;--text-muted:#555555;
--accent-green:#00d4aa;--accent-red:#ff4757;--border-color:#2a2a2a;
}

html,body{overflow-x:hidden}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;padding:40px 20px}
.container{max-width:1200px;margin:0 auto}

/* Header - centered */
.header{text-align:center;padding:30px 0 20px;border-bottom:1px solid var(--border-color);margin-bottom:20px}
.header h1{font-size:1.8rem;font-weight:700;letter-spacing:-0.5px;margin-bottom:6px;background:linear-gradient(135deg,#fff 0%,#888 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.subtitle{color:var(--text-secondary);font-size:0.85rem}

/* Share bar */
.share-bar{display:flex;gap:6px;justify-content:center;margin:16px 0 4px;flex-wrap:wrap}
.share-btn-s{display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:6px;border:1px solid var(--border-color);background:var(--bg-secondary);color:#a1a1aa;font-size:11px;cursor:pointer;font-family:inherit;transition:all 0.2s}
.share-btn-s:hover{border-color:#444;color:var(--text-primary)}
.share-btn-s svg{width:14px;height:14px;flex-shrink:0}
.share-btn-s.twitter:hover{border-color:#1d9bf0;color:#1d9bf0}
.share-btn-s.kakao:hover{border-color:#fee500;color:#fee500}
.share-btn-s.telegram:hover{border-color:#26a5e4;color:#26a5e4}
.share-btn-s.instagram:hover{border-color:#e1306c;color:#e1306c}
.share-btn-s.instagram.copied{border-color:var(--accent-green);color:var(--accent-green)}
.share-btn-s.copy:hover{border-color:var(--accent-green);color:var(--accent-green)}
.share-btn-s.copy.copied{border-color:var(--accent-green);color:var(--accent-green)}
.share-btn-s.copied .label-text{font-weight:600}

/* Toast */
.toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(20px);background:#222;color:#fff;padding:10px 20px;border-radius:8px;font-size:13px;opacity:0;transition:all 0.3s;z-index:9999;pointer-events:none;border:1px solid #333}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* Tabs - centered */
.tab-section{background:var(--bg-tertiary);border-radius:12px;padding:20px;margin-bottom:16px}
.tab-group-label{font-size:0.7rem;color:var(--text-muted);margin-bottom:6px;letter-spacing:1px;text-align:center}
.tab-row{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px;justify-content:center}
.tab-row:last-child{margin-bottom:0}
.tab{padding:7px 14px;border-radius:8px;font-size:0.82rem;cursor:pointer;border:1px solid #2a2a35;background:#111;color:#888;transition:all 0.2s;user-select:none;font-family:inherit}
.tab:hover{background:#222;color:#ccc}
.tab.active{background:#00d4aa;color:#000;font-weight:700;border-color:#00d4aa}

/* Dropdown - centered */
.dropdown-area{display:flex;align-items:center;gap:14px;margin-bottom:20px;justify-content:center}
.dropdown-label{color:#888;font-size:0.85rem;white-space:nowrap}
.dropdown-select{flex:0 1 280px;padding:10px 40px 10px 16px;border-radius:10px;background:var(--bg-tertiary);border:1px solid #333;color:#fff;font-size:0.9rem;font-family:inherit;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23888' fill='none' stroke-width='2'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;cursor:pointer}
.dropdown-select:focus{outline:none;border-color:#00d4aa}

/* Cards */
.insight-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
.insight-card{background:var(--bg-tertiary);border-radius:12px;padding:18px}
.insight-card .label{color:#888;font-size:0.78rem;margin-bottom:6px}
.insight-card .value{font-size:1.2rem;font-weight:700}

/* Chart */
.chart-section{background:var(--bg-tertiary);border-radius:12px;padding:24px;margin-bottom:20px}
.chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px}
.chart-title{font-size:0.95rem;font-weight:700}
.chart-hint{font-size:0.78rem;color:var(--text-muted);margin-top:8px;text-align:center}
.toggle-btns{display:flex;gap:4px}
.toggle-btn{background:#333;border:none;color:#aaa;padding:6px 14px;border-radius:8px;cursor:pointer;font-size:0.8rem;font-family:inherit;transition:all 0.2s}
.toggle-btn.active{background:#00d4aa;color:#000}
.chart-canvas-wrap{width:100%;height:200px;position:relative}
.chart-canvas-wrap canvas{width:100%!important;height:100%!important}
.selected-label{position:absolute;top:8px;left:12px;font-size:0.85rem;font-weight:700;opacity:0;transition:opacity 0.3s;pointer-events:none}
.selected-label.show{opacity:1}

/* Table */
table.main-table{width:100%;border-collapse:collapse}
table.main-table thead th{text-align:left;padding:14px 10px;border-bottom:2px solid #333;font-weight:500;color:#aaa;font-size:0.82rem}
table.main-table thead th:last-child{text-align:right}
.main-row{cursor:pointer;transition:background 0.25s,opacity 0.25s}
.main-row:hover{background:var(--bg-tertiary)}
.main-row td{padding:14px 10px;border-bottom:1px solid #222;font-size:0.93rem}
.main-row.active-row{background:rgba(0,212,170,0.08)}
.main-row.dimmed{opacity:0.35}
.color-dot{display:inline-block;width:9px;height:9px;border-radius:50%;margin-right:8px;vertical-align:middle}
.rank-cell{font-weight:700;color:#666;width:36px}
.apt-name{font-weight:500}
.loc-cell{color:#aaa;font-size:0.85rem}
.arrow{color:#555;font-size:0.7rem;margin-left:6px;transition:transform 0.2s;display:inline-block}
.arrow.open{transform:rotate(180deg)}
.price{text-align:right;font-weight:700;color:#00d4aa;font-variant-numeric:tabular-nums}
.detail-row{display:none}
.detail-row.show{display:table-row}
.detail-row td{padding:0;background:#0d0d0d;border-bottom:1px solid #222}
.detail-content{padding:16px 10px 16px 46px;display:flex;gap:24px;align-items:flex-start}
.detail-info{flex:1}
.detail-table{width:100%;max-width:350px}
.detail-table th{text-align:left;padding:6px 14px 6px 0;color:#666;font-weight:400;font-size:0.85rem;width:80px}
.detail-table td{padding:6px 0;font-size:0.9rem;color:#ccc}
.empty-msg{text-align:center;padding:60px 20px;color:var(--text-muted);font-size:0.95rem}

.footer{margin-top:40px;padding-top:20px;border-top:1px solid #222;color:var(--text-muted);font-size:0.8rem;text-align:center}
@media(max-width:768px){.insight-cards{grid-template-columns:1fr 1fr 1fr}.tab{padding:6px 10px;font-size:0.75rem}.share-btn-s{padding:5px 8px;font-size:10px}.share-btn-s .label-text{display:none}}
@media(max-width:600px){body{padding:20px 12px}.header h1{font-size:1.4rem}.insight-cards{grid-template-columns:1fr}.chart-canvas-wrap{height:180px}.detail-content{flex-direction:column;padding:12px 8px 12px 16px;gap:12px}.main-row td{padding:10px 6px;font-size:0.85rem}}
</style>
</head>
<body>
<div class="container">

<!-- Header -->
<header class="header">
<h1>전국 구별 아파트 평당가 TOP 10</h1>
<p class="subtitle">최근 6개월 실거래 기준 · 전용면적 59㎡ 이상 · 단지별 최고가</p>
</header>

<!-- Share Bar -->
<div class="share-bar">
  <button class="share-btn-s twitter" onclick="shareTwitter()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg><span class="label-text">트위터</span></button>
  <button class="share-btn-s kakao" onclick="shareKakao()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3c-5.52 0-10 3.36-10 7.5 0 2.66 1.74 5 4.36 6.33-.14.53-.9 3.4-.93 3.61 0 0-.02.17.09.23.11.07.24.03.24.03.32-.04 3.7-2.42 4.28-2.83.62.09 1.27.13 1.96.13 5.52 0 10-3.36 10-7.5S17.52 3 12 3z"/></svg><span class="label-text">카카오톡</span></button>
  <button class="share-btn-s telegram" onclick="shareTelegram()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.479.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg><span class="label-text">텔레그램</span></button>
  <button class="share-btn-s instagram" onclick="shareInstagram(this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/></svg><span class="label-text">인스타그램</span></button>
  <button class="share-btn-s copy" onclick="copyLink(this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg><span class="label-text">링크 복사</span></button>
</div>

<!-- Tabs -->
<div class="tab-section">
<div class="tab-group-label">특별시 · 광역시 · 특별자치시</div>
<div class="tab-row" id="metroTabs"></div>
<div class="tab-group-label">도</div>
<div class="tab-row" id="provTabs"></div>
</div>

<!-- Dropdown -->
<div class="dropdown-area">
<div class="dropdown-label">지역 선택</div>
<select class="dropdown-select" id="districtSelect" onchange="onDistrictChange()"></select>
</div>

<!-- Insight Cards -->
<div class="insight-cards" id="insightCards">
<div class="insight-card"><div class="label" id="cardLabel1">TOP 10 평균 평당가</div><div class="value" id="cardVal1" style="color:#00d4aa;">-</div></div>
<div class="insight-card"><div class="label">최고가 단지</div><div class="value" id="cardVal2" style="font-size:1rem;">-</div></div>
<div class="insight-card"><div class="label">거래 건수 (6개월)</div><div class="value" id="cardVal3">-</div></div>
</div>

<!-- Chart -->
<div class="chart-section" id="chartSection">
<div class="chart-header">
<span class="chart-title" id="chartTitle">평당가 추이</span>
<div class="toggle-btns">
<button class="toggle-btn" onclick="setRange(12)" id="btn-1y">1년</button>
<button class="toggle-btn" onclick="setRange(24)" id="btn-2y">2년</button>
<button class="toggle-btn active" onclick="setRange(36)" id="btn-3y">3년</button>
</div>
</div>
<div class="chart-canvas-wrap">
<div class="selected-label" id="selectedLabel"></div>
<canvas id="trendChart"></canvas>
</div>
<div class="chart-hint">아래 리스트에서 아파트를 클릭하면 해당 추이가 강조됩니다</div>
</div>

<!-- Table -->
<table class="main-table">
<thead><tr><th>순위</th><th>단지명</th><th>동</th><th style="text-align:right;">평당가</th></tr></thead>
<tbody id="tableBody"></tbody>
</table>

<div class="footer" id="footerText">데이터 출처: 국토교통부 실거래가 공개시스템</div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
/* ── 공유 ── */
const SHARE_URL = 'https://herdvibe.com/37';
const SHARE_TITLE = '전국 구별 아파트 평당가 TOP 10';
const SHARE_DESC = '최근 6개월 실거래 기준 · 전용면적 59㎡ 이상 · 단지별 최고가';

function openUrl(url) {
    const a = document.createElement('a');
    a.href = url; a.target = '_blank'; a.rel = 'noopener';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
}
function shareTwitter() {
    const text = encodeURIComponent(SHARE_TITLE + ' - ' + SHARE_DESC);
    openUrl('https://twitter.com/intent/tweet?text=' + text + '&url=' + encodeURIComponent(SHARE_URL));
}
function shareKakao() {
    if (typeof Kakao !== 'undefined' && Kakao.isInitialized && Kakao.isInitialized()) {
        Kakao.Share.sendDefault({
            objectType: 'feed',
            content: { title: SHARE_TITLE, description: SHARE_DESC, imageUrl: '', link: { mobileWebUrl: SHARE_URL, webUrl: SHARE_URL } },
            buttons: [{ title: '자세히 보기', link: { mobileWebUrl: SHARE_URL, webUrl: SHARE_URL } }]
        });
    } else {
        openUrl('https://sharer.kakao.com/talk/friends/picker/link?app_key=a43ed7b39fac35458f4f9df925a279b5&ka=sdk%2F2.7.4');
    }
}
function shareTelegram() {
    openUrl('https://t.me/share/url?url=' + encodeURIComponent(SHARE_URL) + '&text=' + encodeURIComponent(SHARE_TITLE));
}
function shareInstagram(btn) {
    doCopy(SHARE_URL);
    if (btn) showCopied(btn);
    showToast('링크가 복사되었습니다. 인스타그램 스토리에 붙여넣기 하세요');
}
function copyLink(btn) {
    doCopy(SHARE_URL);
    if (btn) showCopied(btn);
    showToast('링크가 복사되었습니다');
}
function showCopied(btn) {
    btn.classList.add('copied');
    const svg = btn.querySelector('svg');
    const label = btn.querySelector('.label-text');
    const origSvg = svg ? svg.outerHTML : '';
    const origLabel = label ? label.textContent : '';
    if (svg) svg.outerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px"><polyline points="20 6 9 17 4 12"></polyline></svg>';
    if (label) label.textContent = '복사됨!';
    setTimeout(() => {
        btn.classList.remove('copied');
        const newSvg = btn.querySelector('svg');
        if (newSvg && origSvg) newSvg.outerHTML = origSvg;
        if (label) label.textContent = origLabel;
    }, 2000);
}
function doCopy(text) {
    // 방법1: Clipboard API (top-level + secure context)
    try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).catch(function(){
                fallbackCopy(text);
            });
            return;
        }
    } catch(e) {}
    fallbackCopy(text);
}
function fallbackCopy(text) {
    // 방법2: execCommand
    var ta = document.createElement('textarea');
    ta.value = text;
    ta.setAttribute('readonly', '');
    ta.style.position = 'fixed';
    ta.style.left = '0';
    ta.style.top = '0';
    ta.style.width = '2em';
    ta.style.height = '2em';
    ta.style.padding = '0';
    ta.style.border = 'none';
    ta.style.outline = 'none';
    ta.style.boxShadow = 'none';
    ta.style.background = 'transparent';
    ta.style.opacity = '0.01';
    document.body.appendChild(ta);
    if (navigator.userAgent.match(/ipad|ipod|iphone/i)) {
        ta.contentEditable = true;
        ta.readOnly = true;
        var range = document.createRange();
        range.selectNodeContents(ta);
        var sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, 999999);
    } else {
        ta.focus();
        ta.select();
        ta.setSelectionRange(0, ta.value.length);
    }
    try { document.execCommand('copy'); } catch(e) {}
    document.body.removeChild(ta);
}
function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
}
try { if (typeof Kakao !== 'undefined' && !Kakao.isInitialized()) Kakao.init('a43ed7b39fac35458f4f9df925a279b5'); } catch(e) {}

/* ── 지역 매핑 ── */
const REGION_MAP = {
"서울시":["종로구","중구","용산구","성동구","광진구","동대문구","중랑구","성북구","강북구","도봉구","노원구","은평구","서대문구","마포구","양천구","강서구","구로구","금천구","영등포구","동작구","관악구","서초구","강남구","송파구","강동구"],
"인천시":["중구","동구","미추홀구","연수구","남동구","부평구","계양구","서구","강화군","옹진군"],
"부산시":["중구","서구","동구","영도구","부산진구","동래구","남구","북구","해운대구","사하구","금정구","강서구","연제구","수영구","사상구","기장군"],
"대구시":["중구","동구","서구","남구","북구","수성구","달서구","달성군","군위군"],
"광주시":["동구","서구","남구","북구","광산구"],
"대전시":["동구","중구","서구","유성구","대덕구"],
"울산시":["중구","남구","동구","북구","울주군"],
"세종시":["세종시"],
"경기도":["수원시 장안구","수원시 권선구","수원시 팔달구","수원시 영통구","성남시 수정구","성남시 중원구","성남시 분당구","의정부시","안양시 만안구","안양시 동안구","부천시","광명시","평택시","동두천시","안산시 상록구","안산시 단원구","고양시 덕양구","고양시 일산동구","고양시 일산서구","과천시","구리시","남양주시","오산시","시흥시","군포시","의왕시","하남시","용인시 처인구","용인시 기흥구","용인시 수지구","파주시","이천시","안성시","김포시","화성시","광주시","양주시","포천시","여주시","연천군","가평군","양평군"],
"강원도":["춘천시","원주시","강릉시","동해시","태백시","속초시","삼척시","홍천군","횡성군","영월군","평창군","정선군","철원군","화천군","양구군","인제군","고성군","양양군"],
"충북":["청주시 상당구","청주시 서원구","청주시 흥덕구","청주시 청원구","충주시","제천시","보은군","옥천군","영동군","증평군","진천군","괴산군","음성군","단양군"],
"충남":["천안시 동남구","천안시 서북구","공주시","보령시","아산시","서산시","논산시","계룡시","당진시","금산군","부여군","서천군","청양군","홍성군","예산군","태안군"],
"전북":["전주시 완산구","전주시 덕진구","군산시","익산시","정읍시","남원시","김제시","완주군","진안군","무주군","장수군","임실군","순창군","고창군","부안군"],
"전남":["목포시","여수시","순천시","나주시","광양시","담양군","곡성군","구례군","고흥군","보성군","화순군","장흥군","강진군","해남군","영암군","무안군","함평군","영광군","장성군","완도군","진도군","신안군"],
"경북":["포항시 남구","포항시 북구","경주시","김천시","안동시","구미시","영주시","영천시","상주시","문경시","경산시","의성군","청송군","영양군","영덕군","청도군","고령군","성주군","칠곡군","예천군","봉화군","울진군","울릉군"],
"경남":["창원시 의창구","창원시 성산구","창원시 마산합포구","창원시 마산회원구","창원시 진해구","진주시","통영시","사천시","김해시","밀양시","거제시","양산시","의령군","함안군","창녕군","고성군","남해군","하동군","산청군","함양군","거창군","합천군"],
"제주도":["제주시","서귀포시"]
};
const METRO = ["서울시","인천시","부산시","대구시","광주시","대전시","울산시","세종시"];
const PROV = ["경기도","강원도","충북","충남","전북","전남","경북","경남","제주도"];
const TAB_LABELS = {"서울시":"서울","인천시":"인천","부산시":"부산","대구시":"대구","광주시":"광주","대전시":"대전","울산시":"울산","세종시":"세종","경기도":"경기","강원도":"강원","충북":"충북","충남":"충남","전북":"전북","전남":"전남","경북":"경북","경남":"경남","제주도":"제주"};
const COLORS = ["#00d4aa","#4ecdc4","#ff6b6b","#45b7d1","#96ceb4","#ffeaa7","#a29bfe","#fd79a8","#e17055","#74b9ff"];

let DATA = null;
let currentSido = "서울시";
let currentDistrict = "강남구";
let chart = null;
let activeIdx = -1;
let currentRange = 36;
let currentLabels = [];
let currentSeries = [];

function buildTabs() {
    const m = document.getElementById('metroTabs');
    const p = document.getElementById('provTabs');
    METRO.forEach(sido => {
        const t = document.createElement('div');
        t.className = 'tab' + (sido === currentSido ? ' active' : '');
        t.textContent = TAB_LABELS[sido];
        t.onclick = () => selectSido(sido);
        m.appendChild(t);
    });
    PROV.forEach(sido => {
        const t = document.createElement('div');
        t.className = 'tab' + (sido === currentSido ? ' active' : '');
        t.textContent = TAB_LABELS[sido];
        t.onclick = () => selectSido(sido);
        p.appendChild(t);
    });
}

function selectSido(sido) {
    currentSido = sido;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => {
        if (TAB_LABELS[sido] === t.textContent) t.classList.add('active');
    });
    populateDropdown();
    onDistrictChange();
}

function populateDropdown() {
    const sel = document.getElementById('districtSelect');
    sel.innerHTML = '';
    const districts = REGION_MAP[currentSido] || [];
    districts.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d; opt.textContent = d;
        sel.appendChild(opt);
    });
    if (!districts.includes(currentDistrict)) currentDistrict = districts[0] || '';
    sel.value = currentDistrict;
}

function onDistrictChange() {
    const sel = document.getElementById('districtSelect');
    currentDistrict = sel.value;
    activeIdx = -1;
    render();
}

function fp(p) {
    const b = Math.floor(p / 10000);
    const r = p % 10000;
    return b > 0 ? b + '억 ' + r.toLocaleString() + '만' : p.toLocaleString() + '만';
}

function render() {
    const key = currentSido + '|' + currentDistrict;
    const d = DATA ? DATA.data[key] : null;
    document.getElementById('cardLabel1').textContent = currentDistrict + ' TOP 10 평균';
    if (d) {
        document.getElementById('cardVal1').textContent = fp(d.avg);
        document.getElementById('cardVal2').textContent = d.top10[0].name;
        document.getElementById('cardVal3').textContent = d.deals.toLocaleString() + '건';
    } else {
        document.getElementById('cardVal1').textContent = '-';
        document.getElementById('cardVal2').textContent = '-';
        document.getElementById('cardVal3').textContent = '-';
    }
    document.getElementById('chartTitle').textContent = currentDistrict + ' TOP 10 평당가 추이';
    currentLabels = DATA ? DATA.labels : [];
    currentSeries = d ? d.series : [];
    renderChart();
    renderTable(d);
}

function renderChart() {
    if (typeof Chart === 'undefined') {
        const wrap = document.querySelector('.chart-canvas-wrap');
        if (wrap) wrap.innerHTML = '<div style="text-align:center;padding:40px;color:#555;">차트 로딩 중...</div>';
        return;
    }
    try {
    const labels = currentLabels.slice(-currentRange);
    const datasets = currentSeries.map((vals, i) => {
        const sliced = vals.slice(-currentRange);
        return {
            label: getAptName(i), data: sliced, borderColor: COLORS[i],
            backgroundColor: 'transparent', borderWidth: 1.5, pointRadius: 0,
            pointHoverRadius: 4, tension: 0.3, spanGaps: true, _origColor: COLORS[i]
        };
    });
    if (chart) chart.destroy();
    const ctx = document.getElementById('trendChart').getContext('2d');
    chart = new Chart(ctx, {
        type: 'line', data: { labels, datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#1a1a1a', titleColor: '#fff', bodyColor: '#ccc', borderColor: '#333', borderWidth: 1,
                    filter: item => item.raw !== null,
                    callbacks: { label: c => c.raw === null ? null : c.dataset.label + ': ' + fp(c.raw) }
                }
            },
            scales: {
                x: { ticks: { color: '#666', maxRotation: 45, maxTicksLimit: 12 }, grid: { color: '#222' } },
                y: { ticks: { color: '#666', callback: v => { const b = Math.floor(v/10000); return b > 0 ? b+'억' : v.toLocaleString()+'만'; } }, grid: { color: '#222' } }
            }
        }
    });
    if (activeIdx >= 0) highlightChart(activeIdx);
    } catch(e) { console.warn('Chart error:', e); }
}

function getAptName(i) {
    const key = currentSido + '|' + currentDistrict;
    const d = DATA ? DATA.data[key] : null;
    return d && d.top10[i] ? d.top10[i].name : '';
}

function setRange(m) {
    currentRange = m;
    document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(m===12?'btn-1y':m===24?'btn-2y':'btn-3y').classList.add('active');
    renderChart();
}

function renderTable(d) {
    const tbody = document.getElementById('tableBody');
    if (!d || !d.top10.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-msg">해당 지역에 데이터가 없습니다</td></tr>';
        return;
    }
    let html = '';
    d.top10.forEach((apt, i) => {
        const c = COLORS[i];
        html += `<tr class="main-row" data-idx="${i}" onclick="handleRowClick(${i})">
            <td class="rank-cell">${i+1}</td>
            <td class="apt-name"><span class="color-dot" style="background:${c}"></span>${apt.name} <span class="arrow" id="arrow-${i}">▼</span></td>
            <td class="loc-cell">${apt.dong}</td>
            <td class="price">${fp(apt.ppyeong)}</td>
        </tr>
        <tr class="detail-row" id="detail-${i}"><td colspan="4"><div class="detail-content"><div class="detail-info"><table class="detail-table">
            <tr><th>전용면적</th><td>${apt.area_m2}㎡ (${apt.area_pyeong}평)</td></tr>
            <tr><th>거래금액</th><td>${fp_full(apt.price)}</td></tr>
            <tr><th>거래일</th><td>${apt.date}</td></tr>
            <tr><th>층</th><td>${apt.floor}층</td></tr>
            <tr><th>건축년도</th><td>${apt.build_year}년</td></tr>
        </table></div></div></td></tr>`;
    });
    tbody.innerHTML = html;
}

function fp_full(p) {
    const b = p / 10000;
    if (b >= 1) return b === Math.floor(b) ? Math.floor(b) + '억' : b.toFixed(1) + '억';
    return p.toLocaleString() + '만';
}

function highlightChart(idx) {
    if (!chart) return;
    const label = document.getElementById('selectedLabel');
    chart.data.datasets.forEach((ds, i) => {
        if (i === idx) { ds.borderWidth = 3.5; ds.borderColor = ds._origColor; ds.pointRadius = 3; ds.pointBackgroundColor = ds._origColor; }
        else { ds.borderWidth = 1; ds.borderColor = ds._origColor + '1A'; ds.pointRadius = 0; }
    });
    label.textContent = getAptName(idx); label.style.color = COLORS[idx]; label.classList.add('show');
    chart.update();
}

function resetChart() {
    if (!chart) return;
    const label = document.getElementById('selectedLabel');
    chart.data.datasets.forEach(ds => { ds.borderWidth = 1.5; ds.borderColor = ds._origColor; ds.pointRadius = 0; });
    label.classList.remove('show'); chart.update();
}

function highlightRows(idx) {
    document.querySelectorAll('.main-row').forEach((row, i) => {
        if (i === idx) { row.classList.add('active-row'); row.classList.remove('dimmed'); }
        else { row.classList.remove('active-row'); row.classList.add('dimmed'); }
    });
}

function resetRows() { document.querySelectorAll('.main-row').forEach(row => row.classList.remove('active-row','dimmed')); }

function handleRowClick(idx) {
    if (activeIdx === idx) { activeIdx = -1; resetChart(); resetRows(); }
    else { activeIdx = idx; highlightChart(idx); highlightRows(idx); document.getElementById('chartSection').scrollIntoView({ behavior:'smooth', block:'nearest' }); }
    const det = document.getElementById('detail-'+idx);
    const arr = document.getElementById('arrow-'+idx);
    if (det) det.classList.toggle('show');
    if (arr) arr.classList.toggle('open');
}

function genSample() {
    function line(base, seed) {
        const a = []; let v = base, s = seed;
        for (let i = 0; i < 36; i++) { s = (s * 9301 + 49297) % 233280; v += Math.round((s/233280 - 0.38) * 500); a.push(s/233280 > 0.9 ? null : v); }
        return a;
    }
    const labels = [];
    for (let y = 2023; y <= 2026; y++) for (let m = 1; m <= 12; m++) { const l = y+'.'+String(m).padStart(2,'0'); if (labels.length < 36) labels.push(l); }
    const sample = {
        "서울시|강남구": { avg:28500, deals:245, top10:[
            {name:"더펜트하우스청담",dong:"청담동",area_m2:222.86,area_pyeong:67.5,price:1920000,ppyeong:28500,date:"2025.11.28",floor:"15",build_year:"2015"},
            {name:"도곡렉슬",dong:"도곡동",area_m2:84.99,area_pyeong:25.8,price:575000,ppyeong:22300,date:"2025.11.25",floor:"18",build_year:"2003"},
            {name:"타워팰리스3차",dong:"도곡동",area_m2:163.23,area_pyeong:49.5,price:1030000,ppyeong:20800,date:"2025.10.15",floor:"55",build_year:"2004"},
            {name:"래미안대치팰리스",dong:"대치동",area_m2:84.98,area_pyeong:25.7,price:510000,ppyeong:19800,date:"2025.11.22",floor:"16",build_year:"2015"},
            {name:"은마아파트",dong:"대치동",area_m2:84.43,area_pyeong:25.6,price:492000,ppyeong:19200,date:"2025.12.12",floor:"8",build_year:"1979"},
            {name:"개포자이프레지던스",dong:"개포동",area_m2:84.98,area_pyeong:25.7,price:480000,ppyeong:18600,date:"2025.10.08",floor:"22",build_year:"2021"},
            {name:"디에이치자이개포",dong:"개포동",area_m2:84.97,area_pyeong:25.7,price:465000,ppyeong:18100,date:"2025.11.05",floor:"19",build_year:"2021"},
            {name:"대치SK뷰",dong:"대치동",area_m2:84.99,area_pyeong:25.8,price:450000,ppyeong:17400,date:"2025.12.01",floor:"14",build_year:"2018"},
            {name:"래미안블레스티지",dong:"개포동",area_m2:84.98,area_pyeong:25.7,price:440000,ppyeong:17100,date:"2025.10.20",floor:"11",build_year:"2019"},
            {name:"삼성래미안",dong:"대치동",area_m2:84.97,area_pyeong:25.7,price:425000,ppyeong:16500,date:"2025.11.15",floor:"9",build_year:"2009"}
        ], series: Array.from({length:10},(_,i)=>line(28000-i*1200, (i+1)*137))},
        "서울시|서초구": { avg:26800, deals:198, top10:[
            {name:"아크로리버파크",dong:"반포동",area_m2:84.98,area_pyeong:25.7,price:850000,ppyeong:33074,date:"2026.01.15",floor:"25",build_year:"2016"},
            {name:"래미안원베일리",dong:"반포동",area_m2:84.99,area_pyeong:25.8,price:810000,ppyeong:31500,date:"2026.01.10",floor:"32",build_year:"2024"},
            {name:"래미안퍼스티지",dong:"반포동",area_m2:84.97,area_pyeong:25.7,price:653000,ppyeong:25400,date:"2025.12.18",floor:"21",build_year:"2009"},
            {name:"반포자이",dong:"반포동",area_m2:84.94,area_pyeong:25.7,price:638000,ppyeong:24800,date:"2025.10.22",floor:"15",build_year:"2009"},
            {name:"반포래미안아이파크",dong:"반포동",area_m2:59.96,area_pyeong:18.2,price:355000,ppyeong:19500,date:"2025.10.28",floor:"12",build_year:"2018"},
            {name:"잠원래미안",dong:"잠원동",area_m2:84.97,area_pyeong:25.7,price:480000,ppyeong:18600,date:"2025.11.10",floor:"10",build_year:"2010"},
            {name:"서초그랑자이",dong:"서초동",area_m2:84.98,area_pyeong:25.7,price:465000,ppyeong:18100,date:"2025.12.02",floor:"18",build_year:"2021"},
            {name:"래미안서초에스티지",dong:"서초동",area_m2:84.99,area_pyeong:25.8,price:450000,ppyeong:17400,date:"2025.10.05",floor:"15",build_year:"2020"},
            {name:"아크로비스타",dong:"반포동",area_m2:84.97,area_pyeong:25.7,price:435000,ppyeong:16900,date:"2025.11.20",floor:"7",build_year:"2007"},
            {name:"래미안리더스원",dong:"서초동",area_m2:84.98,area_pyeong:25.7,price:420000,ppyeong:16300,date:"2025.12.08",floor:"20",build_year:"2019"}
        ], series: Array.from({length:10},(_,i)=>line(32000-i*1800, (i+3)*97))}
    };
    return { updated:"샘플 데이터", labels, data:sample };
}

async function init() {
    buildTabs();
    populateDropdown();
    try {
        const resp = await fetch('data/district_top10.json');
        if (resp.ok) {
            DATA = await resp.json();
            document.getElementById('footerText').textContent = '마지막 업데이트: ' + DATA.updated + ' · 데이터 출처: 국토교통부 실거래가 공개시스템';
        } else throw new Error();
    } catch(e) {
        DATA = genSample();
        document.getElementById('footerText').textContent = '샘플 데이터 표시 중 · 실제 데이터는 GitHub Actions 실행 후 업데이트됩니다';
    }
    render();
    if (typeof Chart === 'undefined') {
        const retryChart = setInterval(() => { if (typeof Chart !== 'undefined') { clearInterval(retryChart); renderChart(); } }, 200);
        setTimeout(() => clearInterval(retryChart), 10000);
    }
}

if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
else init();
</script>
</body>
</html>
